language: java
jdk: openjdk7
env:
  global:
    - REPO_NAME=atulpundhir/spring-web
    - secure=/m+3n23BplJehEg6hF+2SNHIB0cu1I5JKFwhSyd6Z6IwBvhSUdmy5EJqidRPmVppE58qiHsTOPO4Zkmr6Lqwed5F37Hroz62AvjYk2zVkZOheIqf5xBva0R/aWhZCJomyqLeQxOtSzQTZ5zXw5es1BBbhGtP6ytYcScaYGi8OkLvh2tMjMfBeMzhlS5KA+3wuxgqmfr4ps0WQ1C1bFHh1/hDRe4niZJEleKadftFz1uhV0PIK5dFQxDiO7VM59uAg0OvkVVg2c/zlyY/ABz83oE6UURS1G253HcM9tO4Vo0C0G1rqHVbc2omFrU9g==
before_script:
  - mkdir -p shippable/codecoverage
  # Using cover2cover to translate Jacoco output to Cobertura format for Shippable's sake
  - curl -sO https://raw.githubusercontent.com/rix0rrr/cover2cover/master/cover2cover.py && chmod +x cover2cover.py
after_script:
  - echo "After script is called"
  - python cover2cover.py build/reports/jacoco/test/jacocoTestReport.xml src/main/java > shippable/codecoverage/coverage.xml
after_success:
  - echo "Script is successful"
  - ./src/scripts/deploy.sh
  
branches:
  only:
    - master
    - develop
    - test
  
build:
  pre_ci:
    - echo "PRE-CLI"
    - echo $SHIPPABLE_BUILD_DIR
  pre_ci_boot:
      image_name: atulpundhir/spring-web
      image_tag: latest
      pull: true
      env: FOO=bar
      options: "-v /tmp/shared:/app"
  ci:
    - if [ "$BRANCH" == "master" ]  && [ "$IS_PULL_REQUEST" == true ]; then echo "master branch"; fi
    - if [ "$BRANCH" == "develop" ]  && [ "$IS_PULL_REQUEST" == true ]; then echo "develop branch"; fi
    - if [ "$BRANCH" == "test" ]  && [ "$IS_PULL_REQUEST" == true ]; then echo "test branch"; fi
    - mkdir -p shippable/testresults
    - mvn package
  post_ci:
    - docker build -t $REPO_NAME:$BRANCH.$BUILD_NUMBER .
    - docker push $REPO_NAME:$BRANCH.$BUILD_NUMBER
    - echo "POST CI"
  on_success:
    - echo " Success"
  on_failure:
    - echo " Failed"
    
integrations:                               
  hub:
    - integrationName:  Shippable_Docker_Test    #replace with your subscription integration name   
      type: dockerRegistryLogin                        

